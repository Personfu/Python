# ============================================================
# Docker Compose — Full-Stack Development Environment
# CIS 410 — Cloud & DevOps | Preston Furulie
# ============================================================
# Covers: multi-service orchestration, health checks, volume
# persistence, environment variables, secrets management,
# networking, resource limits, logging, and dependencies.
# ============================================================

version: "3.9"

# ── Custom Network ──────────────────────────────────────────
# All services communicate on an isolated bridge network.
# Service names act as DNS hostnames (e.g., "db", "cache").

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ── Persistent Volumes ─────────────────────────────────────

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local

# ── Secrets ─────────────────────────────────────────────────

secrets:
  db_root_password:
    file: ./secrets/db_root_password.txt
  db_app_password:
    file: ./secrets/db_app_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt

# ── Services ───────────────────────────────────────────────

services:

  # ── API Server (Node.js) ────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: guitar-shop-api
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: guitar_shop
      DB_USER: app_user
      REDIS_URL: redis://cache:6379
      LOG_LEVEL: info
    secrets:
      - db_app_password
      - jwt_secret
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ── MySQL 8.0 Database ──────────────────────────────────
  db:
    image: mysql:8.0
    container_name: guitar-shop-db
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      MYSQL_DATABASE: guitar_shop
      MYSQL_USER: app_user
      MYSQL_PASSWORD_FILE: /run/secrets/db_app_password
    secrets:
      - db_root_password
      - db_app_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "--silent"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=caching_sha2_password
      - --max-connections=100
      - --innodb-buffer-pool-size=256M
      - --slow-query-log=ON
      - --long-query-time=1

  # ── Redis Cache ─────────────────────────────────────────
  cache:
    image: redis:7-alpine
    container_name: guitar-shop-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru

  # ── Nginx Reverse Proxy ─────────────────────────────────
  nginx:
    image: nginx:1.25-alpine
    container_name: guitar-shop-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      api:
        condition: service_healthy
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M

  # ── Adminer (Database GUI — dev only) ────────────────────
  adminer:
    image: adminer:latest
    container_name: guitar-shop-adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-network
    profiles:
      - dev  # only starts with: docker compose --profile dev up
